<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema de Pedidos - Pastes (v2)</title>
<style>
:root{
  --bg:#f4f6ff;
  --card:#ffffff;
  --primary:#5568FE;
  --primary-2:#93A4FF;
  --accent:#FF6B6B;
  --muted:#7b8190;
  --success:#28a745;
  --danger:#dc3545;
  --glass: rgba(255,255,255,0.7);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter, "Segoe UI", Tahoma, Arial;}
body{background:var(--bg);color:#222;padding:20px;}
.container{max-width:1100px;margin:0 auto;}
.header{
  background: linear-gradient(135deg,var(--primary),var(--primary-2));
  color:white;padding:26px;border-radius:14px;box-shadow:0 8px 30px rgba(85,104,254,0.18);margin-bottom:18px;
}
.header h1{font-size:1.9rem;margin-bottom:4px}
.header p{opacity:.9}
.tabs{display:flex;gap:8px;margin-top:12px}
.tab{flex:1;padding:10px 12px;border-radius:10px;background:var(--card);cursor:pointer;text-align:center;font-weight:700;color:var(--muted);box-shadow:0 4px 10px rgba(16,24,40,0.04)}
.tab.active{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));color:var(--primary);box-shadow:0 10px 30px rgba(85,104,254,0.08);transform:translateY(-2px)}
.main{display:flex;gap:20px;margin-top:18px}
/* left column (order) */
.col-left{flex:1}
.col-right{width:460px}
/* card */
.card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
.form-row{margin-bottom:12px}
label{display:block;font-weight:700;margin-bottom:6px}
input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9f2}
.flavors-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.flavor-card{background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,250,255,1));padding:12px;border-radius:12px;border:1px solid rgba(22,28,45,0.03);display:flex;flex-direction:column;align-items:center;justify-content:space-between;gap:8px;transition:transform .14s, box-shadow .14s}
.flavor-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(85,104,254,0.08)}
.flavor-icon{width:64px;height:64px;border-radius:12px;object-fit:cover;box-shadow:0 6px 18px rgba(18,24,80,0.06)}
.flavor-name{font-weight:700;color:#222;text-align:center;font-size:.95rem}
.qty-controls{display:flex;align-items:center;gap:8px}
.qty-btn{width:36px;height:36px;border-radius:9px;border:none;background:var(--primary);color:white;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(85,104,254,0.12);transition:transform .12s}
.qty-btn.minus{background:transparent;color:var(--primary);border:1px solid rgba(85,104,254,0.12)}
.qty-btn:active{transform:translateY(1px) scale(.98)}
.qty-number{min-width:30px;text-align:center;font-weight:800;color:var(--muted)}
.total-card{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;border-radius:12px;background:linear-gradient(90deg,#ffffff,#f7faff);text-align:center}
.total-amount{font-size:1.8rem;color:var(--primary);font-weight:900}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:white;box-shadow:0 8px 20px rgba(85,104,254,0.12)}
.btn-ghost{background:transparent;border:1px solid #eee;color:var(--muted)}
.small-muted{color:var(--muted);font-size:.92rem}
.stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.stat{background:linear-gradient(180deg,#fff,#fbfcff);padding:12px;border-radius:10px;min-width:140px;box-shadow:0 6px 18px rgba(12,20,60,0.04)}
.table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #f1f3fb;text-align:left}
th{background:var(--primary);color:white;border-top-left-radius:8px}
.thumb{width:56px;height:56px;object-fit:cover;border-radius:10px;cursor:pointer;border:2px solid rgba(0,0,0,0.04);transition:transform .12s}
.thumb:hover{transform:scale(1.03)}
.img-modal-bg{position:fixed;inset:0;background:rgba(6,8,20,.72);display:flex;align-items:center;justify-content:center;z-index:9999}
.img-modal-content{max-width:92%;max-height:92%;border-radius:14px;box-shadow:0 18px 60px rgba(8,10,30,0.6);animation:zoomIn .18s ease}
@keyframes zoomIn{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
/* responsive */
@media(max-width:1024px){ .main{flex-direction:column} .col-right{width:100%} .flavors-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Sistema de Pedidos - Pastes</h1>
    <p class="small-muted">Made by Carlos Tisca</p>
    <div class="tabs" style="margin-top:14px;">
      <div class="tab active" data-tab="order">Realizar Pedido</div>
      <div class="tab" data-tab="summary">Resumen</div>
    </div>
  </div>

  <div class="main">
    <div class="col-left">
      <div class="card">
        <div class="form-row">
          <label for="username">Nombre del cliente</label>
          <input id="username" type="text" placeholder="Ej. Juan PÃ©rez">
        </div>

        <h3 style="margin:6px 0 10px 0;">Sabores</h3>
        <div id="flavorsList" class="flavors-grid"></div>

        <div style="height:12px"></div>

        <div style="display:flex;gap:10px;align-items:center;justify-content:flex-start">
          <button id="placeOrderBtn" class="btn btn-primary">Guardar Pedido</button>
          <button id="clearFormBtn" class="btn btn-ghost">Limpiar</button>
          <div id="savingIndicator" style="margin-left:8px"></div>
        </div>
      </div>
    </div>

    <div class="col-right">
      <div class="card" style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small-muted">Total aproximado</div>
            <div class="total-amount" id="totalDisplay">$0</div>
            <div class="small-muted">50$ el par Â· 30$ la pieza</div>
          </div>
          <div style="width:140px">
            <label>MÃ©todo</label>
            <select id="paymentMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9f2">
              <option value="Efectivo">Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Link de pago">Link de pago</option>
            </select>
          </div>
        </div>

        <div id="paymentInfo" style="margin-top:12px"></div>

        <div id="comprobanteWrap" style="margin-top:12px;display:none">
          <label>Adjuntar comprobante</label>
          <input id="comprobanteFile" type="file" accept="image/*" style="width:100%;padding:8px">
          <div id="comprobantePreview" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <div class="small-muted" style="margin-bottom:8px">EstadÃ­sticas rÃ¡pidas</div>
        <div id="statsBar" class="stats"></div>
      </div>
    </div>
  </div>

  <!-- Summary tab content -->
  <div id="summaryContent" style="display:none;margin-top:18px">
    <div class="card">
      <h3>Resumen de Pedidos</h3>
      <div id="ordersList"></div>
      <div id="flavorSummary" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const PASSWORD_RESUMEN = "1212";
const PASSWORD_PAGO = "1212";
const LS_KEY = "pedidos_v2_cache";

/* ---------- FLAVORS + ICON MAP (slug -> filename in /icons) ---------- */
/* AÃ±ade las imÃ¡genes en /icons con estos nombres si las tienes.
   Si no existen, la UI mostrarÃ¡ un emoji de respaldo. */
const flavors = [
  { name: "Leche (Crema Pastelera)", slug:"leche", emoji:"ðŸ¥›" },
  { name: "PiÃ±a (natural casera)", slug:"pina", emoji:"ðŸ" },
  { name: "Philadelphia con PiÃ±a", slug:"philadelphia-pina", emoji:"ðŸ§€ðŸ" },
  { name: "Cajeta (Cajeta horneada)", slug:"cajeta", emoji:"ðŸ¯" },
  { name: "Nutella (de avellana)", slug:"nutella", emoji:"ðŸ«" },
  { name: "Philadelphia con Zarzamora", slug:"philadelphia-zarzamora", emoji:"ðŸ§€ðŸ‡" },
  { name: "PlÃ¡tano Macho (con lechera)", slug:"platano", emoji:"ðŸŒ" },
  { name: "Peperoni", slug:"peperoni", emoji:"ðŸ•" },
  { name: "Hawaiana", slug:"hawaiana", emoji:"ðŸðŸ•" },
  { name: "Italiana", slug:"italiana", emoji:"ðŸ‡®ðŸ‡¹" },
  { name: "JamÃ³n con queso amarillo", slug:"jamon-queso", emoji:"ðŸ¥“ðŸ§€" },
  { name: "Choriqueso", slug:"choriqueso", emoji:"ðŸŒ­ðŸ§€" },
  { name: "ChampiÃ±ones", slug:"champinones", emoji:"ðŸ„" },
  { name: "AtÃºn", slug:"atun", emoji:"ðŸŸ" }
];

/* ---------- STATE ---------- */
let orders = [];
function loadLocal(){ try{ orders = JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{orders=[];} }
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(orders)); }

/* ---------- HELPERS ---------- */
function $(sel){ return document.querySelector(sel); }
function createEl(tag, attrs={}, inner=""){ const e = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); e.innerHTML = inner; return e; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

/* ---------- RENDER FLAVORS (cards with + / -) ---------- */
function renderFlavors(){
  const el = document.getElementById("flavorsList");
  el.innerHTML = "";
  flavors.forEach((f, idx) => {
    const card = document.createElement("div");
    card.className = "flavor-card";
    // icon (try /icons/<slug>.png)
    const iconPath = `/icons/${f.slug}.png`;
    const img = document.createElement("img");
    img.className = "flavor-icon";
    img.onerror = () => { img.style.display = "none"; emojiSpan.style.display = "block"; };
    img.src = iconPath;

    const emojiSpan = document.createElement("div");
    emojiSpan.style.fontSize = "28px";
    emojiSpan.style.display = "none";
    emojiSpan.textContent = f.emoji;

    const name = document.createElement("div");
    name.className = "flavor-name";
    name.innerText = f.name;

    const controls = document.createElement("div");
    controls.className = "qty-controls";
    const minus = document.createElement("button");
    minus.className = "qty-btn minus";
    minus.innerText = "âˆ’";
    const number = document.createElement("div");
    number.className = "qty-number";
    number.innerText = 0;
    number.dataset.idx = idx;
    const plus = document.createElement("button");
    plus.className = "qty-btn plus";
    plus.innerText = "+";

    // animate on click
    function pulse(elm){
      elm.animate([{ transform:"scale(1)" }, { transform:"scale(.96)" }, { transform:"scale(1)" }], { duration:120 });
    }

    plus.addEventListener("click", () => {
      number.innerText = Number(number.innerText || 0) + 1;
      pulse(plus);
      calcularTotal();
    });
    minus.addEventListener("click", () => {
      number.innerText = Math.max(0, Number(number.innerText||0) - 1);
      pulse(minus);
      calcularTotal();
    });

    controls.appendChild(minus);
    controls.appendChild(number);
    controls.appendChild(plus);

    card.appendChild(img);
    card.appendChild(emojiSpan);
    card.appendChild(name);
    card.appendChild(controls);

    el.appendChild(card);
  });
}

/* ---------- CALCULAR TOTAL ---------- */
function calcularTotal(){
  let totalP=0;
  document.querySelectorAll(".qty-number").forEach(n => totalP += Number(n.innerText||0));
  const pares = Math.floor(totalP/2);
  const sobrante = totalP % 2;
  const total = pares*50 + sobrante*30;
  document.getElementById("totalDisplay").innerText = `$${total}`;
  return { total, totalP };
}

/* ---------- PAYMENT UI ---------- */
function updatePaymentInfo(){
  const val = document.getElementById("paymentMethod").value;
  const paymentInfo = document.getElementById("paymentInfo");
  const comprobanteWrap = document.getElementById("comprobanteWrap");
  if(val === "Transferencia"){
    paymentInfo.innerHTML = `<div style="padding:10px;background:linear-gradient(90deg,#f9fbff,#fff);border-radius:8px">
      <div class="small-muted"><strong>Banco</strong> BANORTE</div>
      <div class="small-muted"><strong>Cuenta</strong> 4189 1400 7895 1844</div>
      <div class="small-muted"><strong>Nombre</strong> Nayeli Salazar</div>
      <div style="margin-top:6px;color:var(--muted)">Adjunta comprobante</div>
    </div>`;
    comprobanteWrap.style.display = "block";
  } else if(val === "Link de pago"){
    const { total } = calcularTotal();
    const final = (total*1.0244 + 4).toFixed(2);
    paymentInfo.innerHTML = `<div style="padding:10px;border-radius:8px;background:#fff7f8">
      <div class="small-muted">Total con comisiÃ³n: <strong>$${final}</strong></div>
      <div style="margin-top:8px"><a class="btn btn-primary" href="https://link.mercadopago.com.mx/carlostiscas" target="_blank">Ir a pago</a></div>
    </div>`;
    comprobanteWrap.style.display = "none";
  } else {
    paymentInfo.innerHTML = "";
    comprobanteWrap.style.display = "none";
  }
}

/* ---------- API HELPERS ---------- */
async function apiGet(){
  const res = await fetch("/api/pedidos");
  if(!res.ok) throw new Error("GET failed");
  return await res.json();
}
async function apiCreate(pedido, file){
  const fd = new FormData();
  fd.append("pedido", JSON.stringify(pedido));
  if(file) fd.append("comprobante", file);
  const res = await fetch("/api/pedidos", { method:"POST", body:fd });
  if(!res.ok) throw new Error("POST failed");
  return await res.json();
}
async function apiUpdate(id, data){
  const res = await fetch(`/api/pedidos/${id}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(data) });
  if(!res.ok) throw new Error("PUT failed");
  return await res.json();
}
async function apiDelete(id){
  const res = await fetch(`/api/pedidos/${id}`, { method:"DELETE" });
  if(!res.ok) throw new Error("DELETE failed");
  return await res.json();
}

/* ---------- PLACE ORDER ---------- */
document.getElementById("placeOrderBtn").addEventListener("click", async ()=>{
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("Ingresa el nombre del cliente.");

  const { total, totalP } = calcularTotal();
  if(totalP === 0) return alert("Selecciona al menos un paste.");

  const metodo = document.getElementById("paymentMethod").value;
  let file = null;
  if(metodo === "Transferencia"){
    file = document.getElementById("comprobanteFile").files[0];
    if(!file) return alert("Adjunta el comprobante para Transferencia.");
    document.getElementById("savingIndicator").innerText = "Subiendo comprobante...";
  } else {
    document.getElementById("savingIndicator").innerText = "Guardando pedido...";
  }

  // items
  const items = [];
  document.querySelectorAll(".qty-number").forEach((n,i)=>{
    const qty = Number(n.innerText||0);
    if(qty>0) items.push({ sabor: flavors[i].name, cantidad: qty, slug: flavors[i].slug });
  });

  const pedido = {
    id: Date.now(),
    usuario: name,
    fecha: new Date().toLocaleString(),
    items,
    total,
    metodo,
    pagado: false,
    comprobanteUrl: null,
    comprobanteThumb: null
  };

  try {
    const resp = await apiCreate(pedido, file);
    if(resp && resp.pedido){
      orders.push(resp.pedido);
      saveLocal();
      renderOrders();
      // reset
      document.getElementById("username").value = "";
      document.querySelectorAll(".qty-number").forEach(n=> n.innerText = "0");
      document.getElementById("comprobanteFile").value = "";
      document.getElementById("comprobantePreview").innerHTML = "";
      calcularTotal();
      alert("Pedido guardado âœ…");
    } else {
      alert("Pedido guardado (respuesta inesperada)");
    }
  } catch (e) {
    console.error(e);
    alert("Error al guardar: " + (e.message || e));
  } finally {
    document.getElementById("savingIndicator").innerText = "";
  }
});

/* ---------- RENDER ORDERS ---------- */
function renderOrders(){
  const container = document.getElementById("ordersList");
  container.innerHTML = "";
  if(orders.length === 0){
    container.innerHTML = "<div class='small-muted'>AÃºn no hay pedidos.</div>";
    document.getElementById("flavorSummary").innerHTML = "";
    document.getElementById("statsBar").innerHTML = "";
    return;
  }

  // stats
  let totalPedidos = orders.length;
  let totalPastes = 0;
  let totalIngresos = 0;
  let totalPagados = 0;
  const saborMap = {};
  const metodoTot = {}, metodoCnt = {};

  orders.forEach(o=>{
    o.items.forEach(it => {
      totalPastes += it.cantidad;
      saborMap[it.sabor] = (saborMap[it.sabor]||0) + it.cantidad;
    });
    totalIngresos += o.total;
    if(o.pagado) totalPagados++;
    metodoTot[o.metodo] = (metodoTot[o.metodo]||0) + o.total;
    metodoCnt[o.metodo] = (metodoCnt[o.metodo]||0) + 1;
  });

  // stats bar
  const statsBar = document.getElementById("statsBar");
  statsBar.innerHTML = `
    <div class="stat"><div class="small-muted">Pedidos</div><strong>${totalPedidos}</strong></div>
    <div class="stat"><div class="small-muted">Pastes</div><strong>${totalPastes}</strong></div>
    <div class="stat"><div class="small-muted">Ingresos</div><strong>$${totalIngresos}</strong></div>
    <div class="stat"><div class="small-muted">Pagados</div><strong>${totalPagados}</strong></div>
  `;
  Object.keys(metodoTot).forEach(m=>{
    statsBar.innerHTML += `<div class="stat"><div class="small-muted">${m}</div><strong>$${metodoTot[m]}</strong><div style="font-size:.85rem">${metodoCnt[m]} pedidos</div></div>`;
  });

  // table
  let html = `<table class="table"><thead><tr>
    <th>Cliente</th><th>Sabores</th><th>Total</th><th>MÃ©todo</th><th>Estado</th><th>Comprobante</th><th>Acciones</th>
  </tr></thead><tbody>`;

  orders.forEach(o=>{
    const itemsStr = o.items.map(it => `${it.cantidad}Ã— ${escapeHtml(it.sabor)}`).join(", ");
    const thumbHtml = o.comprobanteThumb ? `<img src="${o.comprobanteThumb}" class="thumb" onclick="openImageModal('${o.comprobanteUrl || o.comprobanteThumb}')">` :
                     (o.comprobanteUrl ? `<img src="${o.comprobanteUrl}" class="thumb" onclick="openImageModal('${o.comprobanteUrl}')">` : "â€”");
    html += `<tr>
      <td><strong>${escapeHtml(o.usuario)}</strong><br><small>${escapeHtml(o.fecha)}</small></td>
      <td>${itemsStr}</td>
      <td>$${o.total}</td>
      <td>${escapeHtml(o.metodo)}</td>
      <td>${o.pagado ? `<span style="color:${'#0a6'};font-weight:800">Pagado</span>` : `<span style="color:${'#b86'};font-weight:800">Pendiente</span>`}</td>
      <td>${thumbHtml}</td>
      <td>
        ${o.pagado ? `<button class="btn btn-ghost" data-id="${o.id}" data-action="pendiente">Marcar Pendiente</button>` : `<button class="btn btn-primary" data-id="${o.id}" data-action="pagado">Marcar Pagado</button>`}
        <button class="btn btn-ghost" data-id="${o.id}" data-action="delete">Eliminar</button>
      </td>
    </tr>`;
  });

  html += "</tbody></table>";
  container.innerHTML = html;

  // flavor summary
  const flavorSummary = document.getElementById("flavorSummary");
  flavorSummary.innerHTML = "<h4>Resumen por sabor</h4><ul>" + Object.entries(saborMap).map(s=>`<li>${escapeHtml(s[0])}: <strong>${s[1]}</strong></li>`).join("") + "</ul>";

  // attach event delegation for actions
  container.querySelectorAll("button[data-action]").forEach(btn=>{
    btn.addEventListener("click", async (e)=>{
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;
      if(action === "delete"){
        if(!confirm("Eliminar pedido?")) return;
        await apiDelete(id);
        orders = orders.filter(o=>o.id!==id);
        saveLocal();
        renderOrders();
      } else if(action === "pagado"){
        const pass = prompt("ContraseÃ±a para marcar como pagado:");
        if(pass !== PASSWORD_PAGO) return alert("ContraseÃ±a incorrecta");
        await apiUpdate(id, { pagado: true });
        const found = orders.find(o=>o.id===id); if(found) found.pagado = true;
        saveLocal();
        renderOrders();
      } else if(action === "pendiente"){
        await apiUpdate(id, { pagado: false });
        const found = orders.find(o=>o.id===id); if(found) found.pagado = false;
        saveLocal();
        renderOrders();
      }
    });
  });
}

/* ---------- IMAGE MODAL ---------- */
function openImageModal(src){
  const bg = document.createElement("div");
  bg.className = "img-modal-bg";
  bg.innerHTML = `<img src="${src}" class="img-modal-content">`;
  bg.addEventListener("click", ()=> bg.remove());
  document.body.appendChild(bg);
}

/* ---------- PREVIEW COMPROBANTE ---------- */
document.getElementById("comprobanteFile").addEventListener("change", (e)=>{
  const p = document.getElementById("comprobantePreview");
  p.innerHTML = "";
  const f = e.target.files[0];
  if(!f) return;
  if(!f.type.startsWith("image/")) { p.innerText = "Archivo no es imagen"; return; }
  const img = document.createElement("img");
  img.src = URL.createObjectURL(f);
  img.style.width = "120px";
  img.style.borderRadius = "10px";
  p.appendChild(img);
});

/* ---------- TABS & INIT ---------- */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", async ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    if(tab === "order"){
      document.getElementById("summaryContent").style.display = "none";
    } else {
      const pass = prompt("ContraseÃ±a para ver el resumen:");
      if(pass !== PASSWORD_RESUMEN){ alert("ContraseÃ±a incorrecta"); document.querySelector('.tab[data-tab="order"]').click(); return; }
      // load from server
      try {
        orders = await apiGet();
        saveLocal();
      } catch(e){
        console.warn("No se pudo obtener del servidor, usando cache.", e);
        loadLocal();
      }
      renderOrders();
      document.getElementById("summaryContent").style.display = "block";
    }
  });
});

document.getElementById("paymentMethod").addEventListener("change", updatePaymentInfo);
document.getElementById("clearFormBtn").addEventListener("click", ()=>{
  document.getElementById("username").value = "";
  document.querySelectorAll(".qty-number").forEach(n=> n.innerText = "0");
  document.getElementById("comprobanteFile").value = "";
  document.getElementById("comprobantePreview").innerHTML = "";
  updatePaymentInfo();
  calcularTotal();
});

/* ---------- START ---------- */
(function init(){
  renderFlavors();
  document.getElementById("paymentMethod").value = "Efectivo";
  updatePaymentInfo();
  loadLocal();
  calcularTotal();
  // attempt to fetch orders initially - non-blocking
  apiGet().then(srv=>{
    orders = srv;
    saveLocal();
  }).catch(()=>{/* ignore */});
})();
</script>
</body>
</html>
